<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rent vs Buy Analysis Tool</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Handle form submission - defined early so onclick handlers can find it
        async function handleFormSubmit(event) {
            if (event) {
                event.preventDefault();
            }
            console.log('Form submitted via handleFormSubmit');
            
            // Hide error and show loading
            document.getElementById('error').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultsContent').style.display = 'none';

            try {
                // Collect form data
                const formData = new FormData(document.getElementById('analysisForm'));
                const data = Object.fromEntries(formData.entries());
                
                // Convert string values to numbers
                Object.keys(data).forEach(key => {
                    const num = parseFloat(data[key]);
                    if (!isNaN(num)) {
                        data[key] = num;
                    }
                });
                
                console.log('Sending to API:', data);

                // Send to API
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || `Analysis failed with status ${response.status}`);
                }

                // Log the full response for debugging
                console.log('API Response:', result);
                console.log('Results:', result.results);

                // Display results
                displayResults(result.results);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('resultsContent').style.display = 'block';
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('error').textContent = `Error: ${error.message}`;
                document.getElementById('error').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
            
            return false;
        }

        // Format currency
        function formatCurrency(value) {
            if (value === null || value === undefined) {
                console.error('formatCurrency called with null/undefined:', value);
                return 'N/A';
            }
            
            const numValue = Number(value);
            if (isNaN(numValue)) {
                console.error('formatCurrency received non-numeric value:', value, typeof value);
                return 'Error';
            }
            
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(numValue);
        }

        // Display results
        function displayResults(results) {
            console.log('displayResults called with:', results);
            console.log('buy_net_cost:', results.buy_net_cost, typeof results.buy_net_cost);
            console.log('rent_net_position:', results.rent_net_position, typeof results.rent_net_position);
            console.log('buying object:', results.buying);
            console.log('renting object:', results.renting);
            
            const rec = results.recommendation;
            const recElement = document.getElementById('recommendation');
            recElement.className = 'recommendation ' + (rec === 'BUY' ? 'buy' : 'rent');
            recElement.innerHTML = `
                <span class="success-check">${rec === 'BUY' ? '‚úì' : '‚úì'}</span>
                <strong>Recommendation: ${rec}</strong><br>
                ${results.advantage_description}
            `;

            // Buying data
            console.log('Setting buying data...');
            document.getElementById('buyDownPayment').textContent = formatCurrency(results.buying.down_payment);
            document.getElementById('buyMonthlyMortgage').textContent = formatCurrency(results.buying.monthly_mortgage);
            document.getElementById('buyTotalMortgage').textContent = formatCurrency(results.buying.total_mortgage_payments);
            document.getElementById('buyTotalInterest').textContent = formatCurrency(results.buying.total_interest_paid);
            document.getElementById('buyPropertyTax').textContent = formatCurrency(results.buying.total_property_tax);
            document.getElementById('buyMaintenance').textContent = formatCurrency(results.buying.total_maintenance);
            document.getElementById('buyInsurance').textContent = formatCurrency(results.buying.total_insurance);
            document.getElementById('buyHOA').textContent = formatCurrency(results.buying.total_hoa);
            
            // Calculate total monthly cost (mortgage + monthly taxes, maintenance, insurance, HOA)
            const analysisYears = parseInt(document.getElementById('analysis_years').value) || 10;
            const monthlyPropertyTax = results.buying.total_property_tax / analysisYears / 12;
            const monthlyMaintenance = results.buying.total_maintenance / analysisYears / 12;
            const monthlyInsurance = results.buying.total_insurance / analysisYears / 12;
            const monthlyHOA = results.buying.total_hoa / analysisYears / 12;
            const totalMonthly = results.buying.monthly_mortgage + monthlyPropertyTax + monthlyMaintenance + monthlyInsurance + monthlyHOA;
            document.getElementById('buyTotalMonthly').textContent = formatCurrency(totalMonthly);
            
            document.getElementById('buyClosing').textContent = formatCurrency(results.buying.closing_costs);
            document.getElementById('buySelling').textContent = formatCurrency(results.buying.selling_costs);
            document.getElementById('buyTotal').textContent = formatCurrency(results.buying.total_costs);
            document.getElementById('buyFinalValue').textContent = formatCurrency(results.buying.final_home_value);
            document.getElementById('buyEquity').textContent = formatCurrency(results.buying.home_equity);
            
            console.log('About to set buyNetPosition with value:', results.buy_net_position);
            document.getElementById('buyNetPosition').textContent = formatCurrency(results.buy_net_position);
            console.log('buyNetPosition set successfully');

            // Renting data
            console.log('Setting renting data...');
            document.getElementById('rentTotal').textContent = formatCurrency(results.renting.total_rent_paid);
            document.getElementById('rentInvestment').textContent = formatCurrency(results.renting.investment_amount);
            
            // Investment growth is final amount minus initial down payment
            const growth = results.renting.investment_amount - results.renting.down_payment;
            console.log('Investment growth calculation:', results.renting.investment_amount, '-', results.renting.down_payment, '=', growth);
            document.getElementById('rentGrowth').textContent = formatCurrency(growth);
            
            console.log('About to set rentNetPosition with value:', results.rent_net_position);
            document.getElementById('rentNetPosition').textContent = formatCurrency(results.rent_net_position);
            console.log('rentNetPosition set successfully');

            // Create the cost chart
            console.log('Checking for monthly_costs data...');
            console.log('monthly_costs exists?', results.monthly_costs !== undefined && results.monthly_costs !== null);
            if (results.monthly_costs) {
                console.log('monthly_costs data found, calling createCostChart...');
                createCostChart(results.monthly_costs);
            } else {
                console.log('WARNING: monthly_costs data is missing from API response!');
                console.log('Full results object:', results);
            }

            // Create the growth chart
            console.log('Checking for yearly_growth data...');
            console.log('yearly_growth exists?', results.yearly_growth !== undefined && results.yearly_growth !== null);
            if (results.yearly_growth) {
                console.log('yearly_growth data found, calling createGrowthChart...');
                createGrowthChart(results.yearly_growth);
            } else {
                console.log('WARNING: yearly_growth data is missing from API response!');
            }

            // Create the investment chart
            console.log('===== STARTING INVESTMENT CHART CREATION =====');
            console.log('Checking for investment data...');
            console.log('results.monthly_costs:', results.monthly_costs);
            if (results.monthly_costs) {
                console.log('monthly_costs exists, keys:', Object.keys(results.monthly_costs));
                console.log('buy_monthly_investments:', results.monthly_costs.buy_monthly_investments);
                console.log('Is array?', Array.isArray(results.monthly_costs.buy_monthly_investments));
                console.log('Length:', results.monthly_costs.buy_monthly_investments ? results.monthly_costs.buy_monthly_investments.length : 'N/A');
            }
            
            if (results.monthly_costs && results.monthly_costs.buy_monthly_investments !== undefined && Array.isArray(results.monthly_costs.buy_monthly_investments)) {
                console.log('Investment data found! Array length:', results.monthly_costs.buy_monthly_investments.length);
                console.log('Calling createInvestmentChart...');
                createInvestmentChart(results.monthly_costs);
                console.log('createInvestmentChart function completed');
            } else {
                console.log('WARNING: investment data is missing or invalid!');
                if (results.monthly_costs) {
                    console.log('monthly_costs keys available:', Object.keys(results.monthly_costs));
                }
            }
            console.log('===== INVESTMENT CHART CREATION COMPLETE =====');
        }

        // Create and display cost chart
        // Global variable to store monthly cost data for filtering
        let monthlyDataCache = null;
        let monthlyInvestmentDataCache = null;

        function createCostChart(monthlyData) {
            // Store the data for later filtering
            monthlyDataCache = monthlyData;
            
            const ctx = document.getElementById('costChart');
            
            if (!ctx) {
                console.error('Canvas element not found');
                return;
            }
            
            console.log('===== CHART DATA DEBUG =====');
            console.log('Full chart data received:', monthlyData);
            console.log('Buy costs length:', monthlyData.buy_costs ? monthlyData.buy_costs.length : 'N/A');
            console.log('Rent costs length:', monthlyData.rent_costs ? monthlyData.rent_costs.length : 'N/A');
            console.log('Years:', monthlyData.years);
            console.log('===========================');
            
            const canvasContext = ctx.getContext('2d');
            
            // Use the years array and cost data directly (already yearly averages)
            const labels = monthlyData.years.map(year => `Year ${year}`);
            const yearlyBuyCosts = monthlyData.buy_costs;
            const yearlyRentCosts = monthlyData.rent_costs;
            
            console.log('Chart labels:', labels);
            console.log('Yearly buy costs:', yearlyBuyCosts);
            console.log('Yearly rent costs:', yearlyRentCosts);
            console.log('Monthly income:', monthlyData.monthly_income);
            
            // Destroy existing chart if it exists
            if (window.costChartInstance) {
                window.costChartInstance.destroy();
            }
            
            const monthlyIncomeData = monthlyData.monthly_income || [];
            
            // Build datasets array based on checkbox selections
            const datasets = [];
            
            if (document.getElementById('filter-buy-cost')?.checked) {
                datasets.push({
                    label: 'Buy - Average Monthly Cost',
                    data: yearlyBuyCosts,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.05)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointBackgroundColor: '#667eea',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverRadius: 7
                });
            }
            
            if (document.getElementById('filter-rent-cost')?.checked) {
                datasets.push({
                    label: 'Rent - Average Monthly Cost',
                    data: yearlyRentCosts,
                    borderColor: '#ff6b6b',
                    backgroundColor: 'rgba(255, 107, 107, 0.05)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointBackgroundColor: '#ff6b6b',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverRadius: 7
                });
            }
            
            if (document.getElementById('filter-monthly-income')?.checked) {
                datasets.push({
                    label: 'Monthly Income',
                    data: monthlyIncomeData,
                    borderColor: '#51cf66',
                    backgroundColor: 'rgba(81, 207, 102, 0.05)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointBackgroundColor: '#51cf66',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverRadius: 7,
                    borderDash: [5, 5]
                });
            }
            
            window.costChartInstance = new Chart(canvasContext, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString('en-US', {maximumFractionDigits: 0});
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            min: 0,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(1) + 'k';
                                },
                                font: {
                                    size: 11
                                },
                                stepSize: 1000
                            },
                            title: {
                                display: true,
                                text: 'Average Monthly Cost ($)',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                drawBorder: true
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Year',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                display: false,
                                drawBorder: true
                            }
                        }
                    }
                }
            });
        }

        // Update chart when filters change
        function updateCostChart() {
            if (monthlyDataCache) {
                createCostChart(monthlyDataCache);
            }
        }



        // Create and display investment chart
        function createInvestmentChart(investmentData) {
            investmentData = investmentData || {};
            monthlyInvestmentDataCache = investmentData;

            console.log('createInvestmentChart called with data:', investmentData);

            const ctx = document.getElementById('investmentChart');
            
            if (!ctx) {
                console.error('Investment chart canvas element not found');
                return;
            }
            
            const canvasContext = ctx.getContext('2d');
            const labels = investmentData.years ? investmentData.years.map(year => `Year ${year}`) : [];
            
            console.log('Investment chart labels:', labels);
            console.log('Monthly income data:', investmentData.monthly_income);
            console.log('Buy investment data:', investmentData.buy_monthly_investments);
            console.log('Rent investment data:', investmentData.rent_monthly_investments);
            
            // Destroy existing chart if it exists
            if (window.investmentChartInstance) {
                window.investmentChartInstance.destroy();
            }
            
            // Build datasets based on checkbox selections
            const datasets = [];
            
            // Check if checkboxes exist, if not, show all by default
            const filterIncomeCheckbox = document.getElementById('filter-income');
            const filterBuyCheckbox = document.getElementById('filter-investment-buy');
            const filterRentCheckbox = document.getElementById('filter-investment-rent');
            
            const showIncome = !filterIncomeCheckbox || filterIncomeCheckbox.checked;
            const showBuy = !filterBuyCheckbox || filterBuyCheckbox.checked;
            const showRent = !filterRentCheckbox || filterRentCheckbox.checked;
            
            if (showIncome && Array.isArray(investmentData.monthly_income) && investmentData.monthly_income.length > 0) {
                datasets.push({
                    label: 'Monthly Income',
                    data: investmentData.monthly_income,
                    borderColor: '#764ba2',
                    backgroundColor: 'rgba(118, 75, 162, 0.05)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointBackgroundColor: '#764ba2',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverRadius: 7
                });
            }
            
            if (showBuy && Array.isArray(investmentData.buy_monthly_investments) && investmentData.buy_monthly_investments.length > 0) {
                datasets.push({
                    label: 'Monthly Investment (Buy)',
                    data: investmentData.buy_monthly_investments,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.05)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointBackgroundColor: '#3498db',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverRadius: 7
                });
            }
            
            if (showRent && Array.isArray(investmentData.rent_monthly_investments) && investmentData.rent_monthly_investments.length > 0) {
                datasets.push({
                    label: 'Monthly Investment (Rent)',
                    data: investmentData.rent_monthly_investments,
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.05)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointBackgroundColor: '#e74c3c',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverRadius: 7
                });
            }
            
            console.log('Investment chart datasets created:', datasets.length, 'datasets');
            
            window.investmentChartInstance = new Chart(canvasContext, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString('en-US', {maximumFractionDigits: 0});
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            min: 0,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(1) + 'k';
                                },
                                font: {
                                    size: 11
                                }
                            },
                            title: {
                                display: true,
                                text: 'Amount ($)',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                drawBorder: true
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Year',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                display: false,
                                drawBorder: true
                            }
                        }
                    }
                }
            });
        }

        // Update investment chart when filters change
        function updateInvestmentChart() {
            if (monthlyInvestmentDataCache) {
                createInvestmentChart(monthlyInvestmentDataCache);
            }
        }

        // Create and display growth chart
        function createGrowthChart(growthData) {
            const ctx = document.getElementById('growthChart');
            
            if (!ctx) {
                console.error('Growth chart canvas element not found');
                return;
            }
            
            console.log('===== GROWTH CHART DATA DEBUG =====');
            console.log('Full growth data received:', growthData);
            console.log('Home equity length:', growthData.home_equity_after_sales ? growthData.home_equity_after_sales.length : 'N/A');
            console.log('Home equity values:', growthData.home_equity_after_sales);
            console.log('Buy gains values:', growthData.investment_gains_buy);
            console.log('Rent gains values:', growthData.investment_gains_rent);
            console.log('=====================================');
            
            const canvasContext = ctx.getContext('2d');
            
            // Create year labels
            const labels = growthData.years.map(year => `Year ${year}`);
            console.log('Chart labels:', labels);
            
            // Destroy existing chart if it exists
            if (window.growthChartInstance) {
                window.growthChartInstance.destroy();
            }
            
            window.growthChartInstance = new Chart(canvasContext, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Buy Total Available Cash (Equity + Investments)',
                            data: growthData.buy_total_available_cash,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 2,
                            type: 'line',
                            yAxisID: 'y'
                        },
                        {
                            label: 'Rent Total Available Cash (Investment Portfolio)',
                            data: growthData.rent_total_available_cash,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            borderWidth: 2,
                            type: 'line',
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString('en-US', {maximumFractionDigits: 0});
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            min: 0,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                },
                                font: {
                                    size: 11
                                }
                            },
                            title: {
                                display: true,
                                text: 'Wealth Value ($)',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                drawBorder: true
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Year',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                display: false,
                                drawBorder: true
                            }
                        }
                    }
                }
            });
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: block;
            margin-bottom: 20px;
        }

        .form-section {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .results-section {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-section h2 {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-section h3 {
            font-size: 1em;
            margin-top: 25px;
            margin-bottom: 15px;
            color: #555;
            font-weight: 600;
        }

        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 30px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .recommendation {
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.2em;
            font-weight: 600;
        }

        .recommendation.buy {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: #1a5f3a;
            border-left: 5px solid #2ecc71;
        }

        .recommendation.rent {
            background: linear-gradient(135deg, #fa8072 0%, #ff6b6b 100%);
            color: white;
            border-left: 5px solid #ff6b6b;
        }

        .comparison-table {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .comparison-box {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            border: 2px solid #e0e0e0;
        }

        .comparison-box h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .comparison-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.95em;
        }

        .comparison-item:last-child {
            border-bottom: none;
        }

        .comparison-label {
            color: #666;
            font-weight: 500;
        }

        .comparison-value {
            color: #333;
            font-weight: 600;
        }

        .net-cost {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            text-align: center;
            font-weight: 600;
            font-size: 1.1em;
            color: #333;
        }

        .loading {
            display: none;
            text-align: center;
            color: #666;
            font-size: 1.1em;
            padding: 20px;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
            border-left: 4px solid #c33;
        }

        .success-check {
            display: inline-block;
            color: #2ecc71;
            font-size: 1.5em;
            margin-right: 10px;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            position: relative;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .chart-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            flex-shrink: 0;
        }

        .chart-filters {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .chart-canvas-wrapper {
            position: relative;
            height: 450px;
            width: 100%;
            flex-grow: 1;
        }

        .chart-canvas-wrapper canvas {
            max-height: 100%;
            max-width: 100%;
        }

        .chart-filters label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
            font-size: 0.95em;
            color: #555;
        }

        .chart-filters input[type="checkbox"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        @media (max-width: 1024px) {
            .main-content {
                display: block;
            }

            .comparison-table {
                grid-template-columns: 1fr;
            }

            header h1 {
                font-size: 1.8em;
            }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .form-section {
                padding: 20px;
            }

            .results-section {
                padding: 20px;
            }
        }

        /* Tab Styles */
        .tab-navigation {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 30px;
            gap: 10px;
        }

        .tab-button {
            padding: 12px 24px;
            background: none;
            border: none;
            font-size: 1em;
            font-weight: 500;
            color: #333;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            margin-bottom: -2px;
        }

        .tab-button:hover {
            color: #000;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Affordability Section Styles */
        .affordability-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .affordability-inputs {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .affordability-inputs .form-group {
            margin-bottom: 15px;
        }

        .affordability-inputs button {
            margin-top: 10px;
        }

        .tax-results {
            background: #f5f5f5;
            padding: 25px;
            border-radius: 8px;
            margin-top: 30px;
        }

        .tax-results h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .tax-results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .tax-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tax-item.total-tax {
            background: #e8f0fe;
            border-left-color: #667eea;
            font-weight: 600;
        }

        .tax-item.after-tax {
            background: #e8f5e9;
            border-left-color: #51cf66;
            font-weight: 600;
        }

        .tax-label {
            color: #555;
        }

        .tax-value {
            color: #333;
            font-weight: 600;
            font-size: 1.1em;
        }

        .affordability-info {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #51cf66;
        }

        .affordability-info h4 {
            color: #333;
            margin-top: 0;
        }

        .affordability-info ul {
            list-style-position: inside;
            line-height: 1.8;
        }

        .affordability-info li {
            margin: 10px 0;
            color: #555;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        /* Analysis Tab Layout */
        #analysis-tab {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }

        @media (max-width: 1024px) {
            #analysis-tab {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè† Rent vs Buy Analysis</h1>
            <p>Make an informed financial decision about your housing</p>
        </header>

        <div class="main-content">
            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <button class="tab-button active" onclick="switchTab(this, 'analysis-tab')">Rent vs Buy Analysis</button>
                <button class="tab-button" onclick="switchTab(this, 'affordability-tab')">Home Affordability</button>
            </div>

            <!-- Analysis Tab -->
            <div id="analysis-tab" class="tab-content active">
            <!-- Form Section -->
            <div class="form-section">
                <h2>Analysis Parameters</h2>
                <form id="analysisForm">
                    <h3>Basic Information</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="purchase_price">Purchase Price ($)</label>
                            <input type="number" id="purchase_price" name="purchase_price" value="500000" required>
                        </div>
                        <div class="form-group">
                            <label for="down_payment">Down Payment ($)</label>
                            <input type="number" id="down_payment" name="down_payment" value="100000" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="monthly_rent">Monthly Rent ($)</label>
                            <input type="number" id="monthly_rent" name="monthly_rent" value="2000" required>
                        </div>
                        <div class="form-group">
                            <label for="analysis_years">Analysis Period (years)</label>
                            <input type="number" id="analysis_years" name="analysis_years" min="1" value="10" required>
                        </div>
                    </div>

                    <h3>Mortgage Terms</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="loan_term_years">Loan Term (years)</label>
                            <input type="number" id="loan_term_years" name="loan_term_years" min="1" value="30" required>
                        </div>
                        <div class="form-group">
                            <label for="annual_interest_rate">Interest Rate (%)</label>
                            <input type="number" id="annual_interest_rate" name="annual_interest_rate" step="0.1" value="6.5" required>
                        </div>
                    </div>

                    <h3>Ownership Costs</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="annual_property_tax_rate">Property Tax (% of value)</label>
                            <input type="number" id="annual_property_tax_rate" name="annual_property_tax_rate" step="0.1" value="1.2" required>
                        </div>
                        <div class="form-group">
                            <label for="annual_maintenance_rate">Maintenance (% of value)</label>
                            <input type="number" id="annual_maintenance_rate" name="annual_maintenance_rate" step="0.1" value="1.0" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="annual_insurance_rate">Insurance (% of value)</label>
                            <input type="number" id="annual_insurance_rate" name="annual_insurance_rate" step="0.1" value="0.5" required>
                        </div>
                        <div class="form-group">
                            <label for="annual_hoa">Annual HOA Fees (% of home price)</label>
                            <input type="number" id="annual_hoa" name="annual_hoa" value="0.2" step="0.01" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="closing_costs_percent">Closing Costs (% of purchase price)</label>
                        <input type="number" id="closing_costs_percent" name="closing_costs_percent" step="0.1" value="3" required>
                    </div>

                    <h3>Market Assumptions</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="annual_appreciation_rate">Home Appreciation (% per year)</label>
                            <input type="number" id="annual_appreciation_rate" name="annual_appreciation_rate" step="0.1" value="3.0" required>
                        </div>
                        <div class="form-group">
                            <label for="annual_market_return">Market Return (% per year)</label>
                            <input type="number" id="annual_market_return" name="annual_market_return" step="0.1" value="7.0" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="annual_rent_increase_rate">Rent Increase (% per year)</label>
                        <input type="number" id="annual_rent_increase_rate" name="annual_rent_increase_rate" step="0.1" value="3.0" required>
                    </div>

                    <h3>Income & Investment</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="monthly_income">Monthly Income ($)</label>
                            <input type="number" id="monthly_income" name="monthly_income" value="5000" required>
                        </div>
                        <div class="form-group">
                            <label for="annual_inflation_rate">Annual Inflation Rate (% per year)</label>
                            <input type="number" id="annual_inflation_rate" name="annual_inflation_rate" step="0.1" value="2.5" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="monthly_investment_percentage">Monthly Investment Percentage (% of income)</label>
                        <input type="number" id="monthly_investment_percentage" name="monthly_investment_percentage" step="0.1" value="10.0" required>
                    </div>

                    <button type="button" id="submitBtn" onclick="handleFormSubmit(event)">Analyze Buy vs Rent</button>
                </form>
            </div>

            <!-- Results Section -->
            <div class="results-section">
                <h2>Analysis Results</h2>
                <div class="error" id="error"></div>
                <div class="loading" id="loading">Analyzing...</div>

                <div id="resultsContent" style="display: none;">
                    <div id="recommendation" class="recommendation"></div>

                    <div class="comparison-table">
                        <div class="comparison-box">
                            <h3>üí∞ Buying Scenario</h3>
                            <div class="comparison-item">
                                <span class="comparison-label">Down Payment:</span>
                                <span class="comparison-value" id="buyDownPayment">-</span>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-label">Monthly Mortgage:</span>
                                <span class="comparison-value" id="buyMonthlyMortgage">-</span>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-label">Total Mortgage Payments:</span>
                                <span class="comparison-value" id="buyTotalMortgage">-</span>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-label">Total Interest Paid:</span>
                                <span class="comparison-value" id="buyTotalInterest">-</span>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-label">Property Tax:</span>
                                <span class="comparison-value" id="buyPropertyTax">-</span>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-label">Maintenance:</span>
                                <span class="comparison-value" id="buyMaintenance">-</span>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-label">Insurance:</span>
                                <span class="comparison-value" id="buyInsurance">-</span>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-label">HOA Fees:</span>
                                <span class="comparison-value" id="buyHOA">-</span>
                            </div>
                            <div class="comparison-item" style="border-top: 2px solid #ddd; padding-top: 12px; margin-top: 8px; font-weight: 600;">
                                <span class="comparison-label">Total Monthly Cost:</span>
                                <span class="comparison-value" id="buyTotalMonthly">-</span>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-label">Closing Costs:</span>
                                <span class="comparison-value" id="buyClosing">-</span>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-label">Selling Costs:</span>
                                <span class="comparison-value" id="buySelling">-</span>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-label">Total Cost of Ownership:</span>
                                <span class="comparison-value" id="buyTotal">-</span>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-label">Final Home Value:</span>
                                <span class="comparison-value" id="buyFinalValue">-</span>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-label">Home Equity (after sales):</span>
                                <span class="comparison-value" id="buyEquity">-</span>
                            </div>
                            <div class="net-cost">
                                Net Position: <span id="buyNetPosition">-</span>
                            </div>
                        </div>

                        <div class="comparison-box">
                            <h3>üè¢ Renting & Investing Scenario</h3>
                            <div class="comparison-item">
                                <span class="comparison-label">Total Rent Paid:</span>
                                <span class="comparison-value" id="rentTotal">-</span>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-label">Down Payment Invested:</span>
                                <span class="comparison-value" id="rentInvestment">-</span>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-label">Investment Growth:</span>
                                <span class="comparison-value" id="rentGrowth">-</span>
                            </div>
                            <div class="net-cost">
                                Net Position: <span id="rentNetPosition">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">Average Monthly Cost by Year</div>
                        <div class="chart-filters">
                            <label><input type="checkbox" id="filter-buy-cost" checked onchange="updateCostChart()"> Buy Cost</label>
                            <label><input type="checkbox" id="filter-rent-cost" checked onchange="updateCostChart()"> Rent Cost</label>
                            <label><input type="checkbox" id="filter-monthly-income" checked onchange="updateCostChart()"> Monthly Income</label>
                        </div>
                        <div class="chart-canvas-wrapper">
                            <canvas id="costChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">Wealth Growth Over Time</div>
                        <div class="chart-canvas-wrapper">
                            <canvas id="growthChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">Monthly Income & Investment</div>
                        <div class="chart-filters">
                            <label><input type="checkbox" id="filter-income" checked onchange="updateInvestmentChart()"> Monthly Income</label>
                            <label><input type="checkbox" id="filter-investment-buy" checked onchange="updateInvestmentChart()"> Investment (Buy)</label>
                            <label><input type="checkbox" id="filter-investment-rent" checked onchange="updateInvestmentChart()"> Investment (Rent)</label>
                        </div>
                        <div class="chart-canvas-wrapper">
                            <canvas id="investmentChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Analysis Tab -->

            <!-- Affordability Tab -->
            <div id="affordability-tab" class="tab-content">
                <div class="affordability-section">
                    <h2>Home Affordability Calculator</h2>
                    <p>Calculate your after-tax income to determine home affordability</p>

                    <div class="affordability-inputs">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="gross_annual_income">Gross Annual Income ($)</label>
                                <input type="number" id="gross_annual_income" placeholder="100000" min="0" step="1000">
                            </div>
                            <div class="form-group">
                                <label for="state_code">State</label>
                                <select id="state_code"></select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="filing_status">Filing Status</label>
                                <select id="filing_status">
                                    <option value="single">Single</option>
                                    <option value="married">Married Filing Jointly</option>
                                </select>
                            </div>
                        </div>
                        <button onclick="calculateTaxes()" class="btn-primary">Calculate After-Tax Income</button>
                    </div>

                    <div id="tax-results" class="tax-results" style="display: none;">
                        <h3>Tax Breakdown</h3>
                        <div class="tax-results-grid">
                            <div class="tax-item">
                                <span class="tax-label">Gross Annual Income:</span>
                                <span class="tax-value" id="result-gross">$0</span>
                            </div>
                            <div class="tax-item">
                                <span class="tax-label">Federal Income Tax:</span>
                                <span class="tax-value" id="result-federal">$0</span>
                            </div>
                            <div class="tax-item">
                                <span class="tax-label">State Income Tax:</span>
                                <span class="tax-value" id="result-state">$0</span>
                            </div>
                            <div class="tax-item">
                                <span class="tax-label">FICA Taxes (Social Security & Medicare):</span>
                                <span class="tax-value" id="result-fica">$0</span>
                            </div>
                            <div class="tax-item total-tax">
                                <span class="tax-label">Total Taxes:</span>
                                <span class="tax-value" id="result-total-tax">$0</span>
                            </div>
                            <div class="tax-item total-tax">
                                <span class="tax-label">Effective Tax Rate:</span>
                                <span class="tax-value" id="result-tax-rate">0%</span>
                            </div>
                            <div class="tax-item after-tax">
                                <span class="tax-label">After-Tax Annual Income:</span>
                                <span class="tax-value" id="result-after-tax">$0</span>
                            </div>
                            <div class="tax-item after-tax">
                                <span class="tax-label">After-Tax Monthly Income:</span>
                                <span class="tax-value" id="result-after-tax-monthly">$0</span>
                            </div>
                        </div>

                        <div class="affordability-info">
                            <h4>Home Affordability Guidelines</h4>
                            <ul>
                                <li><strong>Housing Expense Ratio:</strong> Your monthly mortgage, taxes, insurance, and HOA should not exceed 28% of your after-tax monthly income</li>
                                <li><strong>Total Debt Ratio:</strong> Your total monthly debt payments should not exceed 36% of your after-tax monthly income</li>
                                <li><strong>Typical Home Price Range:</strong> 2.5x to 3x your annual gross income</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Affordability Tab -->
        </div>
    </div>

    <script>
        // Tab switching function
        function switchTab(button, tabName) {
            console.log('switchTab called with tabName:', tabName);
            
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            console.log('Found tabs:', tabs.length);
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all buttons
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            const tabElement = document.getElementById(tabName);
            console.log('Tab element found:', tabElement !== null);
            if (tabElement) {
                tabElement.classList.add('active');
                console.log('Added active class to tab, display:', window.getComputedStyle(tabElement).display);
            }
            
            // Add active class to clicked button
            button.classList.add('active');
            console.log('Tab switching complete');
        }

        // Tax Calculator  function
        async function calculateTaxes() {
            const grossIncome = parseFloat(document.getElementById('gross_annual_income').value);
            const stateCode = document.getElementById('state_code').value;
            const filingStatus = document.getElementById('filing_status').value;

            if (!grossIncome || grossIncome <= 0) {
                alert('Please enter a valid gross annual income');
                return;
            }

            try {
                const response = await fetch('/api/affordability', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        gross_annual_income: grossIncome,
                        state_code: stateCode,
                        filing_status: filingStatus
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to calculate taxes');
                }

                // Format currency function for tax results
                const formatCurrency = (value) => {
                    return new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD',
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }).format(value);
                };

                // Display results
                const taxInfo = result.tax_info;
                document.getElementById('result-gross').textContent = formatCurrency(taxInfo.gross_annual_income);
                document.getElementById('result-federal').textContent = formatCurrency(taxInfo.federal_tax);
                document.getElementById('result-state').textContent = formatCurrency(taxInfo.state_tax);
                document.getElementById('result-fica').textContent = formatCurrency(taxInfo.fica_tax);
                document.getElementById('result-total-tax').textContent = formatCurrency(taxInfo.total_tax);
                document.getElementById('result-tax-rate').textContent = taxInfo.effective_tax_rate + '%';
                document.getElementById('result-after-tax').textContent = formatCurrency(taxInfo.after_tax_income);
                document.getElementById('result-after-tax-monthly').textContent = formatCurrency(taxInfo.after_tax_monthly_income);

                // Show results
                document.getElementById('tax-results').style.display = 'block';
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Load states on page load
        window.addEventListener('DOMContentLoaded', async function() {
            console.log('DOMContentLoaded event fired');
            try {
                const stateSelect = document.getElementById('state_code');
                console.log('State select element found:', stateSelect !== null);
                
                if (!stateSelect) {
                    console.error('state_code element not found!');
                    return;
                }
                
                const response = await fetch('/api/affordability', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        gross_annual_income: 50000,
                        state_code: 'CA'
                    })
                });
                
                console.log('API Response status:', response.status);
                const result = await response.json();
                const states = result.available_states;
                console.log('States received:', states.length);
                
                states.forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state;
                    if (state === 'CA') option.selected = true;
                    stateSelect.appendChild(option);
                });
                
                console.log('State dropdown populated with', states.length, 'states');
            } catch (error) {
                console.error('Error loading states:', error);
            }
        });
    </script>
</body>
</html>

